<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legado Guevara-Jáuregui: Documental Interactivo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Playfair Display (Titles) & Lato (Body) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- AOS CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>
    
    <style>
        /* --- HISTORICAL DOCUMENTARY PALETTE --- */
        :root {
            --color-bg-dark: #1c1917;    /* Stone 900 (Warm Black) */
            --color-card-bg: rgba(28, 25, 23, 0.98); /* Stone 900 opacity */
            --color-text-cream: #f5f5f4; /* Stone 100 (Cream/Paper) */
            --color-gold-antique: #a16207; /* Amber 700 (Antique Gold - Deeper) */
            --color-gold-light: #fcd34d;   /* Amber 300 (Highlight - Brighter) */
            --color-green-forest: #14532d; /* Green 900 (Deep Forest) */
            --color-green-light: #15803d;  /* Green 700 (Button Hover) */
        }
        
        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--color-bg-dark);
            color: var(--color-text-cream);
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        /* Typography Override for Historical Feel */
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
        }

        /* Large Typography Mandate */
        h1 { font-size: 3.8rem !important; line-height: 1.1 !important; }
        h2 { font-size: 2.8rem !important; margin-bottom: 1.5rem !important; }
        p, li { font-size: 1.6rem !important; line-height: 1.8 !important; color: #d6d3d1; }

        /* Documentary Card Styling */
        .card-docu {
            background: var(--color-card-bg);
            border: 1px solid var(--color-gold-antique);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        /* Ornamental accent line for cards */
        .card-docu::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--color-gold-light), var(--color-gold-antique), var(--color-gold-light));
        }

        .card-docu:hover {
            transform: translateY(-3px);
            border-color: var(--color-gold-light);
        }

        /* Buttons: Elegant & Historical */
        .btn-hist {
            background-color: var(--color-green-forest);
            color: #fff;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 0.8rem 2.5rem;
            border: 1px solid var(--color-gold-antique);
            border-radius: 0.5rem;
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            text-transform: uppercase;
            font-size: 1.2rem;
        }

        .btn-hist:hover {
            background-color: var(--color-green-light);
            border-color: var(--color-gold-light);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.4);
            color: var(--color-gold-light);
        }
        
        .btn-hist:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Scrollytelling Section Styling */
        .story-section {
            min-height: 100vh;
            padding: 6rem 0;
            opacity: 0; 
            transform: translateY(50px);
            border-left: 2px solid var(--color-gold-antique); /* Subtle timeline line */
            margin-left: 1rem;
            padding-left: 2rem;
        }
        
        .story-section.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Interactive Elements */
        .draggable-item {
            cursor: grab;
            background-color: #292524; /* Stone 800 */
            border: 1px solid var(--color-gold-light); /* Highlight for draggable */
            padding: 1rem;
            margin: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            font-family: 'Lato', sans-serif;
            font-size: 1.3rem;
            color: var(--color-gold-light);
        }
        
        .draggable-item:active { cursor: grabbing; }

        .drop-target {
            border: 2px dashed var(--color-gold-antique);
            background-color: rgba(161, 98, 7, 0.1); /* Light gold accent bg */
            min-height: 6rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            margin-top: 1rem;
            transition: background-color 0.3s;
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--color-gold-light);
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 0 10px rgba(252, 211, 77, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--color-green-forest);
            border-radius: 2px;
        }
        
        /* Loading spinner is now local (no API) */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-gold-light);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 p-4 bg-stone-900 border-b-4 border-amber-500 shadow-2xl" data-aos="fade-down">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="#home" class="text-2xl font-serif font-bold tracking-widest text-amber-300 hover:text-amber-100 transition">
                <i class="fas fa-scroll mr-2"></i> GUEVARA-JÁUREGUI
            </a>
            <div class="hidden md:flex space-x-8 text-lg font-serif">
                <a href="#home" class="text-stone-300 hover:text-amber-300 transition">Portada</a>
                <a href="#cronicas" class="text-stone-300 hover:text-amber-300 transition">La Historia</a>
                <a href="#simulator" class="text-stone-300 hover:text-amber-300 transition">Simulación</a>
                <a href="#trivia" class="text-stone-300 hover:text-amber-300 transition">Trivial Familiar</a>
            </div>
        </div>
    </nav>

    <main>
        <!-- Home Section -->
        <section id="home" class="min-h-screen flex items-center justify-center p-8 bg-cover bg-center bg-fixed" style="background-image: linear-gradient(rgba(28, 25, 23, 0.85), rgba(28, 25, 23, 0.7)), url('https://placehold.co/1920x1080/292524/78716c');">
            <div class="text-center max-w-5xl" data-aos="fade-up" data-aos-duration="1500">
                <div class="mb-4 text-amber-500 font-serif text-2xl tracking-[0.3em] uppercase">Documental Interactivo</div>
                <h1 class="font-black mb-8 text-amber-100 leading-tight drop-shadow-lg">Crónica de un Linaje Antiguo y su Fundación</h1>
                <p class="text-2xl mb-12 text-stone-300 font-light italic">Un recorrido por la memoria de Ángel Guevara Ajuria y Josefina Jáuregui Zumalde.</p>
                
                <button onclick="scrollToSection('#cronicas')" class="btn-hist text-2xl px-12 py-5 shadow-2xl border-2">
                    <i class="fas fa-book-reader mr-3"></i> Abrir el Archivo
                </button>

                <div class="mt-24 grid md:grid-cols-3 gap-10 text-center">
                    <div class="card-docu p-8 bg-opacity-90">
                        <i class="fas fa-landmark text-4xl text-amber-700 mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2 text-amber-100">Historia Viva</h3>
                        <p class="text-lg text-stone-400">Desde la confitería de 1880 hasta la casa de Ilárraza.</p>
                    </div>
                    <div class="card-docu p-8 bg-opacity-90">
                        <i class="fas fa-hourglass-half text-4xl text-amber-700 mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2 text-amber-100">Causa y Efecto</h3>
                        <p class="text-lg text-stone-400">Simula cómo la historia podría haber cambiado.</p>
                    </div>
                    <div class="card-docu p-8 bg-opacity-90">
                        <i class="fas fa-brain text-4xl text-amber-700 mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2 text-amber-100">Sabiduría</h3>
                        <p class="text-lg text-stone-400">Demuestra cuánto conoces tus raíces.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Storytelling Section (Scrollytelling) -->
        <section id="cronicas" class="p-8 md:p-16 relative">
            <!-- Decorative Background Element - Removed opaque texture based on user feedback -->
            <!-- <div class="absolute top-0 left-0 w-full h-full opacity-5 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');"></div> -->

            <h2 class="text-center mb-20 text-amber-500 italic" data-aos="fade-up">Capítulo I: El Origen y la Prosperidad</h2>
            <!-- DIAGRAMA: Árbol Genealógico Guevara-Jáuregui -->
            <p class="text-center text-stone-500 mb-12">[Aquí iría el diagrama del árbol genealógico Guevara-Jáuregui desde 1750 a 1927]</p>

            <div id="story-container" class="max-w-5xl mx-auto">
                
                <!-- 1. ORÍGENES GUEVARA -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-up">
                    <div class="card-docu p-12" id="section-1">
                        <h3 class="text-4xl font-bold text-amber-400 mb-6">El Linaje Guevara: Confiteros de Vitoria</h3>
                        <p>Nuestra historia documentada comienza en <strong>1826</strong>, en Junguitu. Sin embargo, fue <strong>Telesforo Guevara</strong> (nacido en 1843) quien consolidó el nombre de la familia en la capital.</p>
                        <p class="mt-4">Telesforo no era un simple vecino; era un próspero <strong>Confitero</strong> con visión comercial. Su éxito le permitió adquirir múltiples propiedades estratégicas en la Vitoria del siglo XIX.</p>
                        <div class="mt-8 flex justify-end">
                            <button class="text-amber-500 hover:text-amber-300 text-lg flex items-center transition btn-tts" onclick="speakText(this)">
                                <i class="fas fa-volume-up mr-2"></i> Escuchar relato
                                <div class="loader hidden ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ACTIVIDAD 1: El Precio Justo -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-right">
                    <div class="card-docu p-12 bg-gradient-to-br from-stone-900 to-stone-800 border-amber-800">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-amber-900 rounded-full mr-4"><i class="fas fa-search-dollar text-2xl text-amber-200"></i></div>
                            <h3 class="text-3xl font-bold text-amber-100">Desafío: El Valor de la Historia</h3>
                        </div>
                        <p class="mb-8">En 1880, Telesforo compró la casa de la Calle Barreras. ¿Puedes estimar cuánto pagó en Pesetas de la época?</p>
                        
                        <div id="price-slider-container" class="bg-stone-800 p-8 rounded-xl border border-stone-700">
                            <input type="range" id="price-slider" min="5000" max="15000" value="8000" step="50" class="w-full h-4 mb-6">
                            <div class="flex justify-between text-stone-500 text-sm font-mono mb-2">
                                <span>5.000 Ptas</span>
                                <span>15.000 Ptas</span>
                            </div>
                            <p class="text-center mt-2 text-3xl font-serif text-amber-400">Tu estimación: <span id="price-value">8000</span> Ptas.</p>
                            
                            <button id="check-price" class="btn-hist w-full mt-8">Comprobar Archivo</button>
                            <p id="price-feedback" class="mt-6 text-center text-xl font-bold min-h-[3rem]"></p>
                        </div>
                    </div>
                </div>
                
                <!-- 2. PEDRO JÁUREGUI -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-left">
                    <div class="card-docu p-12" id="section-2">
                        <h3 class="text-4xl font-bold text-amber-400 mb-6">Pedro Jáuregui: "El Regalao"</h3>
                        <p>En la rama materna, destaca la figura imponente de <strong>Pedro Valentín Jáuregui Querejazu</strong> (1851-1930). Hombre de influencia política y secretario del Ayuntamiento de Maestu.</p>
                        <p class="mt-4">Su apodo, <strong>"El Regalao"</strong>, provenía de su acomodada posición: vivía de las rentas de un vasto patrimonio inmobiliario e industrial. Fue un pionero que trajo la modernidad a la villa.</p>
                        <div class="mt-8 flex justify-end">
                            <button class="text-amber-500 hover:text-amber-300 text-lg flex items-center transition btn-tts" onclick="speakText(this)">
                                <i class="fas fa-volume-up mr-2"></i> Escuchar relato
                                <div class="loader hidden ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ACTIVIDAD 2: Hitos -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-up">
                    <div class="card-docu p-12 bg-gradient-to-br from-stone-900 to-stone-800 border-green-900">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-green-900 rounded-full mr-4"><i class="fas fa-industry text-2xl text-green-200"></i></div>
                            <h3 class="text-3xl font-bold text-amber-100">Memoria Industrial</h3>
                        </div>
                        <p class="mb-6">Pedro impulsó dos industrias clave en Maestu. Selecciónalas:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button class="hitos-option btn-hist bg-stone-700 hover:bg-stone-600 border-stone-600 normal-case text-left pl-6" data-answer="Fábrica de Harinas">Fábrica de Harinas</button>
                            <button class="hitos-option btn-hist bg-stone-700 hover:bg-stone-600 border-stone-600 normal-case text-left pl-6" data-answer="Central Eléctrica">Central Eléctrica</button>
                            <button class="hitos-option btn-hist bg-stone-700 hover:bg-stone-600 border-stone-600 normal-case text-left pl-6" data-answer="Minas de Asfalto">Minas de Asfalto</button>
                            <button class="hitos-option btn-hist bg-stone-700 hover:bg-stone-600 border-stone-600 normal-case text-left pl-6" data-answer="Banco Local">Banco Local</button>
                        </div>
                        <button id="check-hitos" class="btn-hist w-full mt-8 bg-amber-700 border-amber-600">Verificar Datos</button>
                        <p id="hitos-feedback" class="mt-4 text-center text-xl font-bold"></p>
                    </div>
                </div>

                <!-- 3. LA TRAGEDIA -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-right">
                    <div class="card-docu p-12 border-l-4 border-l-red-900" id="section-3">
                        <h3 class="text-4xl font-bold text-red-900/80 mb-6" style="color: #9f1239;">La Sombra de la Tragedia</h3>
                        <p>La riqueza no exime del dolor. Pedro y su esposa Guadalupe tuvieron tres hijos, pero la desgracia golpeó pronto.</p>
                        <p class="mt-4">Tras la muerte de la pequeña Inés, <strong>Guadalupe falleció en 1901</strong>, consumida por la tristeza. Nuestra abuela Josefina quedó huérfana a los 7 años, enfrentándose a una infancia dura bajo la tutela de una madrastra.</p>
                        <div class="mt-8 flex justify-end">
                            <button class="text-amber-500 hover:text-amber-300 text-lg flex items-center transition btn-tts" onclick="speakText(this)">
                                <i class="fas fa-volume-up mr-2"></i> Escuchar relato
                                <div class="loader hidden ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ACTIVIDAD 3: Roles -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-left">
                    <div class="card-docu p-12 bg-stone-800">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-stone-700 rounded-full mr-4"><i class="fas fa-user-tag text-2xl text-stone-200"></i></div>
                            <h3 class="text-3xl font-bold text-amber-100">Perfiles Históricos</h3>
                        </div>
                        <p class="mb-6">Asocia cada rasgo biográfico con su protagonista:</p>
                        
                        <div id="roles-container" class="grid grid-cols-2 gap-6 mb-8">
                            <div class="drop-target flex flex-col" data-role="Angel">
                                <span class="text-amber-500 font-serif font-bold mb-2">Dr. Ángel Guevara</span>
                            </div>
                            <div class="drop-target flex flex-col" data-role="Josefina">
                                <span class="text-amber-500 font-serif font-bold mb-2">Josefina Jáuregui</span>
                            </div>
                        </div>

                        <div id="roles-options" class="flex flex-wrap justify-center gap-4 p-4 bg-stone-900 rounded-lg">
                            <div class="draggable-item text-amber-100" data-for="Angel">Médico Cazador</div>
                            <div class="draggable-item text-amber-100" data-for="Josefina">Huérfana a los 7</div>
                            <div class="draggable-item text-amber-100" data-for="Angel">Hijo único sobreviviente</div>
                            <div class="draggable-item text-amber-100" data-for="Josefina">Nieta de 'El Regalao'</div>
                        </div>
                        
                        <button id="check-roles" class="btn-hist w-full mt-6">Confirmar Identidades</button>
                        <p id="roles-feedback" class="mt-4 text-center text-xl font-bold"></p>
                    </div>
                </div>

                <!-- 4. LA BODA DE 1916 -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-up">
                    <div class="card-docu p-12" id="section-4">
                        <h3 class="text-4xl font-bold text-amber-400 mb-6">1916: Una Unión en Tiempos de Guerra</h3>
                        <p>Ángel y Josefina unieron sus destinos el <strong>17 de noviembre de 1916</strong>. No fue en Vitoria, sino en la Basílica del <strong>Santo Cristo en Lezo</strong>.</p>
                        <p class="mt-4">¿La razón? El Santuario de Estíbaliz estaba en obras y el hermano de Josefina, Pepe, cumplía el servicio militar en San Sebastián. Tras la boda, emprendieron un viaje de novios monumental: <strong>6.000 kilómetros en tren</strong>.</p>
                        <div class="mt-8 flex justify-end">
                            <button class="text-amber-500 hover:text-amber-300 text-lg flex items-center transition btn-tts" onclick="speakText(this)">
                                <i class="fas fa-volume-up mr-2"></i> Escuchar relato
                                <div class="loader hidden ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ACTIVIDAD 4: Secuencia -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-right">
                    <div class="card-docu p-12 bg-stone-800">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-blue-900 rounded-full mr-4"><i class="fas fa-list-ol text-2xl text-blue-200"></i></div>
                            <h3 class="text-3xl font-bold text-amber-100">Ordena los Hechos</h3>
                        </div>
                        <p class="mb-6">Restablece el orden cronológico de los eventos nupciales:</p>
                        
                        <div id="sequence-quiz-container" class="space-y-4">
                            <!-- Items to click/drag -->
                            <div class="flex flex-col gap-3" id="draggable-sequence">
                                <div class="sequence-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="2">
                                    <i class="fas fa-church mr-2"></i> Boda en el Santo Cristo de Lezo
                                </div>
                                <div class="sequence-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="1">
                                    <i class="fas fa-envelope mr-2"></i> Petición de mano por carta
                                </div>
                                <div class="sequence-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="3">
                                    <i class="fas fa-train mr-2"></i> Viaje de 6.000 km en tren
                                </div>
                            </div>
                            
                            <!-- Targets -->
                            <div id="drop-targets" class="grid grid-cols-1 gap-4 mt-6">
                                <div class="drop-target border-stone-600" data-target="1"><span class="text-stone-500">1. Primero ocurrió...</span></div>
                                <div class="drop-target border-stone-600" data-target="2"><span class="text-stone-500">2. Después...</span></div>
                                <div class="drop-target border-stone-600" data-target="3"><span class="text-stone-500">3. Finalmente...</span></div>
                            </div>
                        </div>
                        <button id="check-sequence" class="btn-hist w-full mt-6">Validar Cronología</button>
                        <p id="sequence-feedback" class="mt-4 text-center text-xl font-bold"></p>
                    </div>
                </div>

                <!-- 5. EL ÉXODO (1918) -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-left">
                    <div class="card-docu p-12 border-l-4 border-l-stone-500" id="section-5">
                        <h3 class="text-4xl font-bold text-amber-500 mb-6">1918: La Gran Pandemia y el Éxodo</h3>
                        <p>La felicidad en Zalduendo fue efímera. En octubre de 1918, la llamada <strong>Gripe Española</strong> asoló el hogar. En una sola noche fallecieron el patriarca Telesforo y la sirvienta.</p>
                        <p class="mt-4">El dolor impulsó a la familia a abandonar el pueblo y refugiarse en Vitoria. Años más tarde, en 1922, la falta de medicinas se cobró otra vida: la de Felipa, madre de Ángel.</p>
                        <div class="mt-8 flex justify-end">
                            <button class="text-amber-500 hover:text-amber-300 text-lg flex items-center transition btn-tts" onclick="speakText(this)">
                                <i class="fas fa-volume-up mr-2"></i> Escuchar relato
                                <div class="loader hidden ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ACTIVIDAD 5: Causa de Muerte -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-up">
                    <div class="card-docu p-12 bg-stone-800">
                        <div class="flex items-center mb-6">
                            <div class="p-3 bg-red-900 rounded-full mr-4"><i class="fas fa-book-medical text-2xl text-red-200"></i></div>
                            <h3 class="text-3xl font-bold text-amber-100">Causa Médica</h3>
                        </div>
                        <p class="mb-6">¿Cuál fue la causa exacta del fallecimiento de Felipa en 1922?</p>
                        <div class="flex flex-col gap-4">
                            <button class="felipa-option btn-hist bg-stone-700 normal-case text-left" data-correct="false">La Gripe Española (recurrente)</button>
                            <button class="felipa-option btn-hist bg-stone-700 normal-case text-left" data-correct="true">Pulmonía por falta de medicación</button>
                            <button class="felipa-option btn-hist bg-stone-700 normal-case text-left" data-correct="false">Gangrena diabética</button>
                        </div>
                        <p id="felipa-feedback" class="mt-4 text-center text-xl font-bold"></p>
                    </div>
                </div>

                <!-- 6. ILÁRRAZA -->
                <div class="story-section flex flex-col justify-center" data-aos="fade-up">
                    <div class="card-docu p-12" id="section-6">
                        <h3 class="text-4xl font-bold text-amber-400 mb-6">El Renacer en Ilárraza</h3>
                        <p>Tras pasar por Junguitu, en <strong>1924</strong> la familia encuentra su paraíso. Construyen la "preciosa casa" de Ilárraza, donde nacería la benjamina, Finitxu.</p>
                        <p class="mt-4">Allí crecieron José, Ángel, Estíbaliz, Luis María y Finitxu, hasta que en <strong>1955</strong> la familia se trasladó definitivamente a la calle Manuel Iradier 74 en Vitoria.</p>
                        
                        <!-- NUEVA ACTIVIDAD INTERACTIVA: ORDENAR NACIMIENTOS -->
                        <div class="mt-12 bg-stone-900 p-8 rounded-xl border border-amber-600">
                             <div class="flex items-center mb-6">
                                <div class="p-3 bg-amber-700 rounded-full mr-4"><i class="fas fa-sort-numeric-up-alt text-2xl text-amber-100"></i></div>
                                <h3 class="text-3xl font-bold text-amber-100">Desafío: Orden de Nacimiento</h3>
                            </div>
                            <p class="mb-6 text-stone-300">Arrastra los hijos a su posición cronológica correcta (del 1º al 5º):</p>
                            
                            <div id="birth-sequence-container">
                                <div class="grid grid-cols-2 gap-3" id="draggable-birth">
                                    <div class="birth-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="1">José (1917, Zalduendo)</div>
                                    <div class="birth-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="3">Estíbaliz (1922, Junguitu)</div>
                                    <div class="birth-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="2">Ángel (1920, Vitoria)</div>
                                    <div class="birth-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="4">Luis María (1924, Junguitu)</div>
                                    <div class="birth-item draggable-item text-amber-100 bg-stone-700 hover:bg-stone-600 cursor-pointer" data-order="5">Finitxu (1927, Ilárraza)</div>
                                </div>
                                <div id="birth-drop-targets" class="grid grid-cols-5 gap-2 mt-6">
                                    <div class="drop-target border-stone-600" data-target="1"><span class="text-stone-500 text-sm">1º (1917)</span></div>
                                    <div class="drop-target border-stone-600" data-target="2"><span class="text-stone-500 text-sm">2º (1920)</span></div>
                                    <div class="drop-target border-stone-600" data-target="3"><span class="text-stone-500 text-sm">3º (1922)</span></div>
                                    <div class="drop-target border-stone-600" data-target="4"><span class="text-stone-500 text-sm">4º (1924)</span></div>
                                    <div class="drop-target border-stone-600" data-target="5"><span class="text-stone-500 text-sm">5º (1927)</span></div>
                                </div>
                            </div>
                            <button id="check-birth-sequence" class="btn-hist w-full mt-6">Validar Secuencia</button>
                            <p id="birth-sequence-feedback" class="mt-4 text-center text-xl font-bold"></p>
                        </div>
                        
                        <div class="mt-8 flex justify-end">
                            <button class="text-amber-500 hover:text-amber-300 text-lg flex items-center transition btn-tts" onclick="speakText(this)">
                                <i class="fas fa-volume-up mr-2"></i> Escuchar relato
                                <div class="loader hidden ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Simulator Section -->
        <section id="simulator" class="min-h-screen p-8 md:p-16 flex flex-col justify-center bg-stone-900 border-t border-amber-900">
            <h2 class="text-center mb-12 text-amber-500 italic">Simulador de Escenarios Históricos</h2>
            <p class="text-xl text-center max-w-4xl mx-auto mb-10 text-stone-400">¿Cómo habría cambiado el destino de la familia si ciertos factores hubieran sido diferentes?</p>

            <div class="card-docu p-12 max-w-6xl mx-auto w-full grid md:grid-cols-3 gap-10 bg-stone-800">
                <!-- Variables Control -->
                <div class="col-span-1 space-y-10 border-r border-stone-700 pr-6">
                    <div>
                        <label class="text-lg font-serif font-bold block mb-3 text-amber-200">Acceso a Medicinas (1922)</label>
                        <input type="range" id="medication-level" min="0" max="100" value="30" class="w-full">
                        <p class="text-sm text-stone-500 mt-2">Nivel: <span id="medication-output">30%</span> (Realidad: Escaso)</p>
                    </div>
                    <div>
                        <label class="text-lg font-serif font-bold block mb-3 text-amber-200">Patrimonio de Telesforo</label>
                        <input type="range" id="estate-value" min="0" max="100" value="80" class="w-full">
                        <p class="text-sm text-stone-500 mt-2">Nivel: <span id="estate-output">80%</span> (Realidad: Alto)</p>
                    </div>
                    <div>
                        <label class="text-lg font-serif font-bold block mb-3 text-amber-200">Servicio Militar de Pepe</label>
                        <select id="pepe-military" class="w-full p-3 rounded bg-stone-900 text-amber-100 border border-stone-600">
                            <option value="true">Sí (En San Sebastián)</option>
                            <option value="false">No (Exento)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Output -->
                <div class="col-span-2 pl-4">
                    <h3 class="text-2xl font-serif font-bold text-amber-100 mb-6 border-b border-stone-600 pb-2">Proyección Alternativa</h3>
                    
                    <div id="sim-explanation" class="mt-6 p-6 bg-stone-900 rounded border border-stone-700 min-h-[200px]">
                        <p id="sim-narrative" class="text-lg leading-relaxed text-stone-300">
                            Modifica las variables a la izquierda y ejecuta la simulación para ver cómo se reescribe la historia.
                        </p>
                    </div>
                    
                    <button onclick="runSimulation()" class="btn-hist w-full mt-8 text-xl py-4 bg-amber-700 border-amber-600">
                        <i class="fas fa-cogs mr-2"></i> Generar Hipótesis
                    </button>
                </div>
            </div>
        </section>

        <!-- Quiz Section (Renamed) -->
        <section id="trivia" class="min-h-screen p-8 md:p-16 flex flex-col justify-center bg-stone-950">
            <h2 class="text-center mb-12 text-amber-400 italic">¡Demuestra cuánto sabes!</h2>
            <p class="text-xl text-center max-w-4xl mx-auto mb-10 text-stone-400">¿Has prestado atención a los detalles de nuestra historia? Responde a estas preguntas.</p>

            <div class="card-docu p-12 max-w-4xl mx-auto w-full bg-stone-900">
                <div id="quiz-container" class="space-y-12">
                    <!-- Dynamic Questions -->
                </div>
                
                <div class="mt-16 pt-8 border-t border-stone-700 flex flex-col items-center">
                    <button id="submit-quiz" class="btn-hist text-xl px-10 py-4 w-full md:w-auto bg-green-800 border-green-700 hover:bg-green-700">
                        <i class="fas fa-award mr-2"></i> Ver Resultados
                    </button>
                    <button id="reset-quiz" class="btn-hist bg-stone-700 text-stone-300 border-stone-600 mt-4 hidden">
                        <i class="fas fa-undo mr-2"></i> Intentar de nuevo
                    </button>
                </div>
                
                <div id="quiz-results" class="mt-8 text-center hidden">
                    <h3 class="text-5xl font-serif font-bold text-amber-400 mb-4"><span id="final-score">0/15</span></h3>
                    <p id="quiz-message" class="text-2xl text-stone-300"></p>
                </div>
            </div>
        </section>

        <!-- Local Chat Widget -->
        <div id="chat-widget" class="fixed bottom-6 right-6 z-50">
            <button id="chat-toggle" class="w-14 h-14 rounded-full bg-amber-700 text-white shadow-lg hover:bg-amber-600 transition flex items-center justify-center text-2xl">
                <i class="fas fa-info"></i>
            </button>
            <div id="chat-window" class="hidden absolute bottom-20 right-0 w-80 bg-stone-800 border border-amber-700 rounded-lg p-4 shadow-2xl">
                <h4 class="text-lg font-bold mb-3 text-amber-400 border-b border-stone-600 pb-2">Guía Rápida</h4>
                <div class="space-y-2">
                    <button class="chat-option w-full text-left p-2 hover:bg-stone-700 rounded text-stone-300 text-sm" data-topic="Telesforo">Sobre Telesforo</button>
                    <button class="chat-option w-full text-left p-2 hover:bg-stone-700 rounded text-stone-300 text-sm" data-topic="ElRegalao">Sobre 'El Regalao'</button>
                    <button class="chat-option w-full text-left p-2 hover:bg-stone-700 rounded text-stone-300 text-sm" data-topic="Lezo">La Boda en Lezo</button>
                    <button class="chat-option w-full text-left p-2 hover:bg-stone-700 rounded text-amber-400 text-sm" data-topic="Analogia">Analogía Histórica (Local)</button>
                </div>
                <div id="chat-content" class="mt-4 p-3 bg-stone-900 rounded text-sm text-stone-400 italic">
                    Selecciona un tema para obtener una explicación.
                </div>
            </div>
        </div>
        
    </main>

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000;"></canvas>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        // --- DATA ---
        const QUIZ_QUESTIONS = [
            { q: "¿En qué año aparece el dato más antiguo del linaje Guevara?", a: "1826", options: ["1843", "1826", "1887", "1916"] },
            { q: "¿Cuál era el oficio de Telesforo Guevara?", a: "Confitero", options: ["Médico", "Notario", "Confitero", "Diputado"] },
            { q: "¿Cuánto pagó Telesforo por la casa de C/Barreras?", a: "10.750 Ptas.", options: ["7.300 Ptas.", "11.500 Ptas.", "10.750 Ptas.", "4.525 Ptas."] },
            { q: "¿Cómo apodaban a Pedro Jáuregui?", a: "El Regalao", options: ["El Cazador", "El Regalao", "El Confitero", "El Escribano"] },
            { q: "¿Por qué falleció Guadalupe Zumalde en 1901?", a: "Tristeza por la pérdida de su hija", options: ["Gripe Española", "Pulmonía", "Tristeza por la pérdida de su hija", "Accidente"] },
            { q: "¿Qué fundó Pedro Jáuregui en Maestu?", a: "Minas de Asfalto y Central Eléctrica", options: ["Molino de Harinas", "Minas de Asfalto y Central Eléctrica", "Fábrica de Chocolates", "Tranvía"] },
            { q: "¿Dónde se casaron Ángel y Josefina?", a: "Basílica del Santo Cristo en Lezo", options: ["Estíbaliz", "San Vicente", "Basílica del Santo Cristo en Lezo", "Junguitu"] },
            { q: "¿Por qué la boda fue en Lezo?", a: "Estíbaliz estaba en obras", options: ["Pepe vivía allí", "Estíbaliz estaba en obras", "Era tradición", "Por cercanía"] },
            { q: "¿Distancia del viaje de novios?", a: "6.000 km", options: ["3.000 km", "600 km", "1.500 km", "6.000 km"] },
            { q: "¿Quiénes murieron en Zalduendo en 1918?", a: "Telesforo y la sirvienta", options: ["Felipa", "Telesforo y la sirvienta", "José", "Pepe"] },
            { q: "¿Causa de muerte de Felipa Ajuria?", a: "Falta de medicación", options: ["Gripe", "Vejez", "Gangrena", "Falta de medicación"] },
            { q: "¿Quién nació en la casa de Ilárraza?", a: "Finitxu", options: ["Estíbaliz", "Luis María", "Finitxu", "Ángel"] },
            { q: "¿Año de la mudanza final a Manuel Iradier?", a: "1955", options: ["1927", "1930", "1955", "1965"] },
            { q: "¿Quién de los hijos nació en Vitoria?", a: "Ángel", options: ["José", "Estíbaliz", "Ángel", "Luis María"] },
            { q: "¿Quién era Obdulia Echevarría?", a: "La Modista", options: ["La Modista", "La prima", "La madre", "La sirvienta"] }
        ];

        const CHAT_CONTENT_LOCAL = {
            Telesforo: "Confitero próspero (1843-1918). Compró propiedades en C/Barreras y C/Francia. Falleció durante la pandemia de 1918.",
            ElRegalao: "Pedro Jáuregui (1851-1930). Político e industrial de Maestu. Trajo la luz eléctrica y explotó las minas de asfalto.",
            Lezo: "Lugar de la boda en 1916. Elegido porque Estíbaliz estaba en obras y el hermano de la novia hacía la mili cerca.",
            Analogia: "La posición de 'El Regalao' era como ser dueño de una gran corporación de tecnología e inmobiliaria en los años 2000. La tragedia de la Gripe y la falta de medicinas es como una pandemia global donde el tratamiento vital está agotado. El impacto emocional y económico era devastador e incontrolable."
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            AOS.init({ duration: 1200, once: true });
            gsap.registerPlugin(ScrollTrigger, Draggable);
            
            initAnimations();
            initPriceActivity();
            initHitosActivity();
            initRolesActivity();
            initSequenceActivity();
            initFelipaActivity();
            initSimulator();
            initQuiz();
            initChat();
            initBirthSequenceActivity(); // Initialize the new activity
            
            // Check for TTS support on load
            if (!('speechSynthesis' in window)) {
                console.warn("Web Speech API no soportada. La función de 'Escuchar relato' no funcionará.");
            }
        });

        // --- CORE LOGIC (STATIC) ---

        // TTS using native Web Speech API (Local Only)
        function speakText(button) {
            if (!('speechSynthesis' in window)) {
                alert("La función de lectura en voz alta no está disponible en este navegador.");
                return;
            }

            const textContainer = button.closest('.card-docu');
            if (!textContainer) return;
            
            let textToSpeak = '';
            textContainer.querySelectorAll('h3, h4, p').forEach(el => {
                // Clean up interactive button text from narrative
                let text = el.textContent.replace(/Escuchar relato/g, '').trim();
                textToSpeak += text + '. ';
            });
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'es-ES';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }
        
        // --- ANIMATIONS ---
        function initAnimations() {
            // Smooth reveal for story sections
            document.querySelectorAll('.story-section').forEach(section => {
                gsap.to(section, {
                    opacity: 1,
                    y: 0,
                    duration: 1.2,
                    ease: "power2.out",
                    scrollTrigger: {
                        trigger: section,
                        start: "top 75%",
                        toggleActions: "play none none reverse"
                    }
                });
            });
        }

        // --- ACTIVITY 1: PRICE SLIDER (FIXED) ---
        function initPriceActivity() {
            const slider = document.getElementById('price-slider');
            const output = document.getElementById('price-value');
            const btn = document.getElementById('check-price');
            const feedback = document.getElementById('price-feedback');
            const target = 10750;

            slider.addEventListener('input', (e) => {
                output.innerText = e.target.value;
            });

            btn.addEventListener('click', () => {
                const val = parseInt(slider.value);
                const diff = Math.abs(val - target);
                
                // Tolerance: within 100 ptas
                if(diff <= 100) { 
                    feedback.className = "mt-6 text-center text-xl font-bold text-green-400";
                    feedback.innerHTML = `<i class="fas fa-check-circle"></i> ¡Exacto! 10.750 Ptas.`;
                    showConfetti(btn);
                    btn.disabled = true;
                } else if (diff <= 1000) {
                    feedback.className = "mt-6 text-center text-xl font-bold text-amber-400";
                    feedback.innerText = `Estás cerca (${target} Ptas)... Ajusta un poco más.`;
                } else {
                    feedback.className = "mt-6 text-center text-xl font-bold text-red-400";
                    feedback.innerText = `Lejos. El precio real fue ${target} Ptas.`;
                }
            });
        }

        // --- ACTIVITY 2: HITOS ---
        function initHitosActivity() {
            const btns = document.querySelectorAll('.hitos-option');
            const check = document.getElementById('check-hitos');
            const feedback = document.getElementById('hitos-feedback');
            const correct = ["Central Eléctrica", "Minas de Asfalto"];
            
            btns.forEach(btn => {
                btn.onclick = () => {
                    if(btn.classList.contains('bg-amber-600')) {
                        btn.classList.remove('bg-amber-600', 'text-white', 'border-amber-400');
                        btn.classList.add('bg-stone-700', 'border-stone-600');
                    } else {
                        btn.classList.add('bg-amber-600', 'text-white', 'border-amber-400');
                        btn.classList.remove('bg-stone-700', 'border-stone-600');
                    }
                };
            });

            check.onclick = () => {
                const selected = Array.from(document.querySelectorAll('.hitos-option.bg-amber-600')).map(b => b.dataset.answer);
                const isMatch = selected.length === 2 && selected.every(s => correct.includes(s));
                
                if(isMatch) {
                    feedback.innerHTML = `<span class="text-green-400">¡Correcto! Pedro trajo la modernidad.</span>`;
                    showConfetti(check);
                    check.disabled = true;
                } else {
                    feedback.innerHTML = `<span class="text-red-400">Selecciona solo las dos industrias fundadas por él.</span>`;
                }
            };
        }

        // --- ACTIVITY 3: ROLES ---
        function initRolesActivity() {
            const items = document.querySelectorAll('#roles-options .draggable-item');
            const targets = document.querySelectorAll('#roles-container .drop-target');
            const check = document.getElementById('check-roles');
            
            items.forEach(item => {
                item.onclick = () => {
                    if(item.parentElement.classList.contains('drop-target')) {
                        // Return to pool
                        document.getElementById('roles-options').appendChild(item);
                        item.classList.remove('bg-amber-700');
                    } else {
                        // Move to first empty target or swap
                        for(let t of targets) {
                            if(t.children.length < 3) { // 1 span title + max 2 items
                                t.appendChild(item);
                                item.classList.add('bg-amber-700');
                                break;
                            }
                        }
                    }
                };
            });

            check.onclick = () => {
                let score = 0;
                document.querySelectorAll('#roles-container .draggable-item').forEach(item => {
                    if(item.parentElement.dataset.role === item.dataset.for) score++;
                });
                
                const feedback = document.getElementById('roles-feedback');
                if(score === 4) {
                    feedback.innerHTML = `<span class="text-green-400">¡Identidades Correctas!</span>`;
                    showConfetti(check);
                } else {
                    feedback.innerHTML = `<span class="text-amber-400">Algunos datos no coinciden. Revisa.</span>`;
                }
            };
        }

        // --- ACTIVITY 4: SEQUENCE ---
        function initSequenceActivity() {
            const items = document.querySelectorAll('#draggable-sequence .sequence-item');
            const targets = document.querySelectorAll('#drop-targets .drop-target');
            const check = document.getElementById('check-sequence');

            items.forEach(item => {
                item.onclick = () => {
                    if(item.parentElement.classList.contains('drop-target')) {
                        document.getElementById('draggable-sequence').appendChild(item);
                        item.classList.remove('bg-blue-800');
                    } else {
                        for(let t of targets) {
                            if(t.children.length === 1) { // Only title span exists
                                t.appendChild(item);
                                item.classList.add('bg-blue-800');
                                break;
                            }
                        }
                    }
                };
            });

            check.onclick = () => {
                let correct = 0;
                targets.forEach(t => {
                    const item = t.querySelector('.sequence-item');
                    if(item && item.dataset.order === t.dataset.target) correct++;
                });

                const fb = document.getElementById('sequence-feedback');
                if(correct === 3) {
                    fb.innerHTML = `<span class="text-green-400">¡Cronología Exacta!</span>`;
                    showConfetti(check);
                } else {
                    fb.innerHTML = `<span class="text-amber-400">El orden no es correcto.</span>`;
                }
            }
        }
        
        // --- NEW ACTIVITY 6: BIRTH SEQUENCE ---
        function initBirthSequenceActivity() {
            const items = document.querySelectorAll('#draggable-birth .birth-item');
            const targets = document.querySelectorAll('#birth-drop-targets .drop-target');
            const check = document.getElementById('check-birth-sequence');

            // Set up click/move logic
            items.forEach(item => {
                item.onclick = () => {
                    if(item.parentElement.classList.contains('drop-target')) {
                        // Return item to source pool
                        document.getElementById('draggable-birth').appendChild(item);
                        item.classList.remove('bg-green-700', 'bg-red-700', 'border-amber-400');
                    } else {
                        // Move to first empty target
                        for(let t of targets) {
                            // Check if only the span is inside (meaning it's empty)
                            if(t.children.length === 1 && t.children[0].tagName === 'SPAN') { 
                                t.appendChild(item);
                                item.classList.add('bg-green-700');
                                break;
                            }
                        }
                    }
                };
            });

            check.onclick = () => {
                let correct = 0;
                let answered = 0;
                targets.forEach(t => {
                    const item = t.querySelector('.birth-item');
                    if (item) {
                        answered++;
                        const expectedOrder = t.dataset.target;
                        if (item.dataset.order === expectedOrder) {
                            correct++;
                            item.classList.remove('bg-green-700', 'bg-red-700');
                            item.classList.add('bg-green-900', 'border-green-400');
                        } else {
                            item.classList.remove('bg-green-700');
                            item.classList.add('bg-red-700', 'border-red-400');
                        }
                    }
                });

                const feedback = document.getElementById('birth-sequence-feedback');
                if(correct === 5) {
                    feedback.innerHTML = `<span class="text-green-400">¡Cronología Familiar Perfecta! (José 17, Ángel 20, Estíbaliz 22, Luis María 24, Finitxu 27)</span>`;
                    showConfetti(check);
                    check.disabled = true;
                } else {
                    feedback.innerHTML = `<span class="text-red-400">Fallo en ${5 - correct} posiciones. Revisa los años y el orden.</span>`;
                }
            };
        }
        
        // --- ACTIVITY 5: FELIPA ---
        function initFelipaActivity() {
            const opts = document.querySelectorAll('.felipa-option');
            const fb = document.getElementById('felipa-feedback');

            opts.forEach(opt => {
                opt.onclick = () => {
                    opts.forEach(o => o.classList.remove('bg-amber-600', 'border-amber-400'));
                    opt.classList.add('bg-amber-600', 'border-amber-400');
                    
                    if(opt.dataset.correct === "true") {
                        fb.innerHTML = `<span class="text-green-400">Correcto. Una tragedia evitable hoy día.</span>`;
                        showConfetti(opt);
                    } else {
                        fb.innerHTML = `<span class="text-red-400">Incorrecto.</span>`;
                    }
                }
            });
        }

        // --- SIMULATOR ---
        function initSimulator() {
            ['medication-level', 'estate-value', 'pepe-military'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSimUI);
            });
        }
        
        function updateSimUI() {
            document.getElementById('medication-output').innerText = document.getElementById('medication-level').value + '%';
            document.getElementById('estate-output').innerText = document.getElementById('estate-value').value + '%';
        }

        function runSimulation() {
            const med = parseInt(document.getElementById('medication-level').value);
            const estate = parseInt(document.getElementById('estate-value').value);
            const pepe = document.getElementById('pepe-military').value === 'true';

            let text = "";
            
            // Medication logic
            if(med > 60) text += "<strong class='text-green-400'>Salud:</strong> Felipa habría sobrevivido a la neumonía gracias a los antibióticos, cambiando la dinámica familiar de los años 20.<br><br>";
            else text += "<strong class='text-red-400'>Salud:</strong> La falta de medicinas condena a Felipa, tal como ocurrió en la realidad.<br><br>";

            // Estate logic
            if(estate < 40) text += "<strong class='text-red-400'>Economía:</strong> Sin el patrimonio de Telesforo, la construcción de la casa de Ilárraza habría sido imposible.<br><br>";
            else text += "<strong class='text-green-400'>Economía:</strong> La solvencia económica permite la estabilidad y la construcción de Ilárraza.<br><br>";

            // Pepe logic
            if(!pepe) text += "<strong class='text-amber-400'>Evento:</strong> Sin Pepe en la mili, la boda probablemente se habría celebrado en Vitoria o Estíbaliz.";
            else text += "<strong class='text-green-400'>Evento:</strong> La mili de Pepe confirma la boda en Lezo.";

            document.getElementById('sim-narrative').innerHTML = text;
        }

        // --- QUIZ ---
        function initQuiz() {
            const container = document.getElementById('quiz-container');
            QUIZ_QUESTIONS.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = "pb-8 border-b border-stone-800 last:border-0";
                div.innerHTML = `
                    <p class="text-xl font-bold mb-4 text-amber-100">${i+1}. ${q.q}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${q.options.map(opt => `
                            <button class="quiz-opt btn-hist bg-stone-800 border-stone-700 normal-case text-left pl-4 hover:bg-stone-700 text-base" onclick="selectQuizOpt(this, '${opt}', '${q.a}')">${opt}</button>
                        `).join('')}
                    </div>
                    <p class="quiz-feedback mt-2 font-bold min-h-[1.5rem]"></p>
                `;
                container.appendChild(div);
            });

            document.getElementById('submit-quiz').onclick = () => {
                let score = 0;
                document.querySelectorAll('.quiz-opt.selected').forEach(btn => {
                    if(btn.dataset.isCorrect === "true") score++;
                });
                
                const scoreDisplay = document.getElementById('final-score');
                scoreDisplay.innerText = `${score} / ${QUIZ_QUESTIONS.length}`;
                
                const msg = document.getElementById('quiz-message');
                if(score === 15) {
                    msg.innerText = "¡Memoria Histórica Perfecta!";
                    msg.className = "text-2xl text-green-400 font-bold";
                    showConfetti(scoreDisplay);
                } else if (score > 10) {
                    msg.innerText = "Gran conocimiento del legado familiar.";
                    msg.className = "text-2xl text-amber-400 font-bold";
                } else {
                    msg.innerText = "Repasa las crónicas e inténtalo de nuevo.";
                    msg.className = "text-2xl text-stone-400";
                }

                document.getElementById('quiz-results').classList.remove('hidden');
                document.getElementById('submit-quiz').classList.add('hidden');
                document.getElementById('reset-quiz').classList.remove('hidden');
                
                // Show answers
                document.querySelectorAll('.quiz-opt').forEach(btn => {
                    btn.disabled = true;
                    if(btn.dataset.val === btn.dataset.correctAnswer) btn.classList.add('bg-green-900', 'border-green-600');
                    else if(btn.classList.contains('selected')) btn.classList.add('bg-red-900', 'border-red-600');
                });
            };

            document.getElementById('reset-quiz').onclick = () => {
                location.reload(); // Simple reset
            };
        }

        window.selectQuizOpt = function(btn, val, correct) {
            // Deselect siblings
            const parent = btn.parentElement;
            parent.querySelectorAll('button').forEach(b => {
                b.classList.remove('selected', 'bg-amber-700', 'border-amber-500');
                b.classList.add('bg-stone-800', 'border-stone-700');
            });
            // Select this
            btn.classList.remove('bg-stone-800', 'border-stone-700');
            btn.classList.add('selected', 'bg-amber-700', 'border-amber-500');
            
            // Store data for validation
            btn.dataset.val = val;
            btn.dataset.correctAnswer = correct;
            btn.dataset.isCorrect = (val === correct);
        };

        // --- CHAT ---
        function initChat() {
            const toggle = document.getElementById('chat-toggle');
            const win = document.getElementById('chat-window');
            const chatContent = document.getElementById('chat-content');

            toggle.onclick = () => win.classList.toggle('hidden');
            
            document.querySelectorAll('.chat-option').forEach(btn => {
                btn.onclick = function() {
                    const topic = this.getAttribute('data-topic');
                    
                    if (topic === 'Analogia') {
                        chatContent.innerHTML = `<p class="font-bold text-amber-400">${this.textContent.replace('(Local)', '')}</p><p class="mt-2 text-stone-300">${CHAT_CONTENT_LOCAL[topic] || 'No se encontró información para este tema localmente.'}</p>`;
                    } else {
                        chatContent.innerHTML = `<p class="font-bold text-amber-400">${this.textContent.replace('✨', '')}</p><p class="mt-2 text-stone-300">${CHAT_CONTENT_LOCAL[topic] || 'No se encontró información para este tema localmente.'}</p>`;
                    }
                }
            });
        }
        
        // --- UTILS ---

        window.scrollToSection = (id) => document.querySelector(id).scrollIntoView({behavior:'smooth'});
        
        // Confetti function remains the same
        function showConfetti(el) {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            for(let i=0; i<60; i++) {
                particles.push({
                    x: el.getBoundingClientRect().left + el.offsetWidth/2,
                    y: el.getBoundingClientRect().top,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 1) * 10,
                    c: ['#fcd34d', '#b45309', '#ffffff'][Math.floor(Math.random()*3)]
                });
            }

            function loop() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                let active = false;
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.5;
                    if(p.y < canvas.height) active = true;
                    ctx.fillStyle = p.c;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
                    ctx.fill();
                });
                if(active) requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>
